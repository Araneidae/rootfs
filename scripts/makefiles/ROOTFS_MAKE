# Top level make file, run from $(TOP)/rootfs, used to coordinate all other
# rootfs makefiles.

include $(TOP)/scripts/makefiles/COMMON
include $(makefiles)/TARGET_COMMON



$(TARGET_ROOT):
	mkdir -p $(TARGET_ROOT)


# Assembling $(sysroot) has to be done entirely within fakeroot.
$(TARGET_ROOT)/imagefile.cpio: $(TARGET_ROOT)
	umask 22  &&  \
        fakeroot -s $(TARGET_ROOT)/fakeroot.env \
            $(MAKE) $@ -f $(makefiles)/SYSROOT_MAKE \
                $(call EXPORT,TARGET configdir)

imagefile: $(TARGET_ROOT)/imagefile.cpio

# Force rebuild of the image file, even if it already exists.
.PHONY: imagefile $(TARGET_ROOT)/imagefile.cpio


default: imagefile



# ----------------------------------------------------------------------------
# Assembles the final images and uploads them into the boot directory.
#
# These are all gathered into a single target, deploy-rootfs

BOOT_DEPENDS ?= $(BOOT_$(BOOT)_DEPENDS)

BOOT_nfs_DEPENDS = $(O)/imagefile.cpio
BOOT_initramfs_DEPENDS = $(O)/imagefile.cpio
BOOT_jffs2_DEPENDS = $(sysroot)
BOOT__DEPENDS = $(O)/imagefile.cpio

deploy-rootfs: $(BOOT_DEPENDS)
	make -C boot -f BOOT_$(BOOT)

.PHONY: deploy-rootfs





default: deploy-rootfs


