# This is the make file invoked under fakeroot where we perform all the
# assembly of the final rootfs directory tree.

# All the work in this make file is done using fakeroot: this allows us to
# create device nodes and manage file ownership and permissions.
#
# The output from this build is a file imagefile.cpio containing the complete
# target file system.

include $(TOP)/scripts/makefiles/COMMON
include $(makefiles)/SYSROOT_COMMON

# Where the skeleton of the rootfs is located.
SKELETON = $(TOP)/skeleton

# By default install DNS and hosts support for name lookup -- these are
# dynamically loaded by the C library, so won't be picked up automatically.
# Also want to install real time and C++ libraries.
EXTRA_LIBS ?= libnss_dns libnss_files librt libstdc++

# By default don't bother with ldconfig at all.
LDCONFIG ?= none



NW_EXPORTS = sysroot NW_HOSTNAME NW_ADDRESS NW_NETMASK NW_GATEWAY
populate_EXPORTS = \
    sysroot BINUTILS_DIR COMPILER_PREFIX TERMS install_list EXTRA_LIBS \
    LIB_PREFIX




# Dependencies of targets (all phony) to sequence build of $(sysroot): the
# correct sequence is:
#   clean-sysroot       Ensures we start with a clean sheet
#   install-sysroot     Does the main work of building the sysroot
#   final-install       Hook for custom configured 
#   post-install        Populates libraries and completes installation


# Erase any existing sysroot directory and prepare a fresh one
clean-sysroot:
	-chmod -R +w $(sysroot)
	rm -rf $(sysroot)
	mkdir -p $(sysroot)


# Prepare the sysroot directory tree, populate with the template skeleton and
# a number of other configurations, and install the packages.
install-sysroot: clean-sysroot
	rm -f $(install_list);  touch $(install_list)
	$(install-files) '$(SKELETON)/file-list'

        # Add target specific getty line to inittab
	echo '::respawn:/sbin/getty $(CONSOLE_BAUD) $(CONSOLE_TTY)' \
            >>$(sysroot)/etc/inittab

        # Configure networking according to selected mode
ifdef NETWORK
	$(call EXPORT,$(NW_EXPORTS)) $(CURDIR)/network $(NETWORK)
endif

	$(useradd) -c 'Root user' -d /root -g 0 -u 0  -s /bin/sh \
            -p $(call SAFE_QUOTE,$(ROOT_PASSWORD)) root
	$(useradd) -c 'daemon' -d /usr/sbin -g 1 -u 1 -s /bin/sh daemon
#	$(useradd) -c 'User' -d / -g 1 -u 10 -s /bin/sh -p '' user

        # Install all the selected packages
	$(MAKE) install -f $(makefiles)/ALL_PACKAGES


final-install: install-sysroot
        # Actions defined in TARGET CONFIG


# Final configuration: populate the libraries and sort out first-time.sh.
post-install: final-install
	$(call EXPORT,$(populate_EXPORTS)) $(scripts)/populate
	$(call EXPORT,sysroot BINUTILS_DIR COMPILER_PREFIX) \
            $(scripts)/ldconfig $(LDCONFIG)

	$(first-time) 'rm /etc/first-time.sh'
	$(first-time) 'mount -o remount,ro /'

ifdef ROOTFS_VERSION
	echo $(call SAFE_QUOTE,$(ROOTFS_VERSION)) >$(sysroot)/etc/version
endif


$(TARGET_ROOT)/imagefile.cpio: post-install
	cd $(sysroot) && \
        find -name . -o -print | cpio --quiet -H newc -o >$@

.PHONY: clean-sysroot install-sysroot final-install post-install 
.PHONY: $(TARGET_ROOT)/imagefile.cpio

default: $(TARGET_ROOT)/imagefile.cpio
