# This is the make file invoked under fakeroot where we perform all the
# assembly of the final rootfs directory tree.
#
# All the work in this make file is done using fakeroot: this allows us to
# create device nodes and manage file ownership and permissions.
#
# The output from this build is a file imagefile.cpio containing the complete
# target file system.

include $(ROOTFS_TOP)/scripts/makefiles/COMMON
include $(makefiles)/SYSROOT_DEFAULTS   # Included *before* TARGET_COMMON!
include $(makefiles)/TARGET_COMMON
include $(makefiles)/SYSROOT_COMMON


_populate_EXPORTS = \
    sysroot BINUTILS_DIR COMPILER_PREFIX \
    TERMS install_list EXTRA_LIBS LIB_PREFIX
populate = $(call EXPORT,$(_populate_EXPORTS)) $(scripts)/populate

define install-option
$(MAKE) -f $(makefiles)/OPTION_MAKE OPTION=$(OPTION) $(1)

endef


# Dependencies of targets (all phony) to sequence build of $(sysroot): the
# correct sequence is:
#   clean-sysroot       Ensures we start with a clean sheet
#   install-sysroot     Does the main work of building the sysroot
#   final-install       Hook for custom configured 
#   post-install        Populates libraries and completes installation

# Erase any existing sysroot directory and prepare a fresh one
clean-sysroot:
	-chmod -R +w $(sysroot)
	rm -rf $(sysroot)
	mkdir -p $(sysroot)

# Prepare the sysroot directory tree, populate with the template skeleton and
# a number of other configurations, and install the packages.
install-sysroot: clean-sysroot
	$(install-files) $(SKELETON)
	$(useradd) -c 'Root user' -d /root -g 0 -u 0  -s /bin/sh \
            -p $(call SAFE_QUOTE,$(ROOT_PASSWORD)) root

        # Install the early options.  Normally this will install inittab,
        # init.d and associated files.
	$(foreach OPTION,$(OPTIONS),$(call install-option,early-option))

        # Record the version string.
	echo $(call SAFE_QUOTE,$(ROOTFS_VERSION)) >$(sysroot)/etc/version
	echo Rootfs built: $(shell date)         >>$(sysroot)/etc/version

        # Install all the selected packages
	rm -f $(install_list);  touch $(install_list)
	$(MAKE) install -f $(makefiles)/ALL_PACKAGES

final-install: install-sysroot
        # Actions defined in TARGET CONFIG

# Final configuration: populate the libraries and sort out first-time.sh.
post-install: final-install
        # Populate the libraries: key final step!
	$(populate)
        # Install the selected options.
	$(foreach OPTION,$(OPTIONS),$(call install-option,option))
        # Wrap up the first-time script.
	$(first-time) -c


%.cpio: post-install
	cd $(sysroot) && \
        find -name . -o -print | cpio --quiet -H newc -o >$@

.PHONY: clean-sysroot install-sysroot final-install post-install 
