#!/bin/bash

# install-files <file-list>
#
# The following environment variable must be set:
#
: ${sysroot:?}      # Target rootfs, where to install files

FILE_LIST="${1:?}"

SOURCE_DIR="$(dirname "$FILE_LIST")"

cat "$FILE_LIST" |
sed '/^[ \t]*#/d; /^[ \t]*$/d' |
while read type mode name value; do
    case $type in
        f)  install -m $mode "$SOURCE_DIR/${value:-$name}" "$sysroot/$name" ;;
        d)  mkdir -m $mode "$sysroot/$name" ;;
        l)  ln -s "$value" "$sysroot/$name" ;;
        n)  install -m $mode /dev/null "$sysroot/$name" ;;
        c)  mknod -m $mode "$sysroot/$name" c $value ;;
        b)  mknod -m $mode "$sysroot/$name" b $value ;;
        p)  mkfifo -m $mode "$sysroot/$name" ;;
        *)  false ;;
    esac  ||  exit 1
done
