#!/bin/bash

# install-files <file-list> [<source-dir>]
#
# If source-dir is specified it is used as the location to find each file in
# file-list, otherwise the root directory of file-list is used.
#
# The following environment variable must be set:
#
: ${sysroot:?}          # Target rootfs, where to install files
: ${fakeroot_list:?}    # Where to place fakeroot commands


HERE="$(dirname "$0")"
. "$HERE"/functions

FILE_LIST="${1:?}"

SOURCE_DIR="${2:-$(dirname "$FILE_LIST")}"

cat "$FILE_LIST" |
sed '/^[ \t]*#/d; /^[ \t]*$/d' |
while read type mode name value; do
    case $type in
        f)  install -m $mode "$SOURCE_DIR/${value:-$name}" "$sysroot/$name" ;;
        d)  mkdir -m $mode "$sysroot/$name" ;;
        l)  ln -s "$value" "$sysroot/$name" ;;
        n)  install -m $mode /dev/null "$sysroot/$name" ;;
        c)  do_root mknod -m $mode "$sysroot/$name" c $value ;;
        b)  do_root mknod -m $mode "$sysroot/$name" b $value ;;
        p)  mkfifo -m $mode "$sysroot/$name" ;;
        *)  false ;;
    esac  ||  exit 1
done
