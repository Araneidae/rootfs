#!/bin/bash

# Simple helper script to create the /etc/network/interfaces file from a
# static configuration, passed as the following parameters:

: ${NW_PORT:?}          # Port to use
if [ "$NW_PORT" != none ]; then
    : ${NW_ADDRESS:?}   # IP address of device
    : ${NW_NETMASK:?}   # Associated net mask
    : ${NW_GATEWAY:?}   # Gateway
fi


# Helper function for the two functions below, called thus:
#
#   compute_elements ip mask action
#
# Returns an IP address generated by applying action to each component of ip
# and mask in turn
compute_elements()
{
    local IFS=.
    IP=($1)
    MASK=($2)

    for ((i = 0; i < 4; i ++)); do
        ip=${IP[i]}
        mask=${MASK[i]}
        ((i > 0))  &&  echo -n .
        eval echo -n '$(('$3'))'
    done
}

# From an IP address and a net mask computes the associated network as
#   IP & mask
compute_network()   { compute_elements $1 $2 'ip & mask'; }
compute_broadcast() { compute_elements $1 $2 '255 & ~(mask & ~ip)'; }

cat <<EOF
auto lo
iface lo inet loopback
EOF

[ "$NW_PORT" = none ]  ||  cat <<EOF
auto $NW_PORT
iface $NW_PORT inet static
    address $NW_ADDRESS
    network $(compute_network $NW_ADDRESS $NW_NETMASK)
    netmask $NW_NETMASK
    broadcast $(compute_broadcast $NW_ADDRESS $NW_NETMASK)
    gateway $NW_GATEWAY
EOF
